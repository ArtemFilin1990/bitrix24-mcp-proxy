INSTRUCTIONS FOR CO-PILOT (CODEX)

Repository: bitrix24-mcp-proxy

1. Главная цель

Поддерживать чистый, стабильный и предсказуемый MCP-прокси Bitrix24.
Все изменения должны улучшать надёжность, покрытие ошибок, согласованность схемы и качество кода.

---

2. Общие правила

1. Всегда проверяй, что изменение согласовано с архитектурой src/core, src/mcp, src/server.

2. Всегда обновляй документацию, если меняешь API, структуру или команды.

3. Всегда следи за консистентностью: единые типы, единый формат ошибок, единый стиль.

4. Никогда не оставляй TODO, временные решения и “quick fixes”.

5. Любое изменение должно проходить тесты и добавлять новые, если логика затронута.



---

3. Требования к коду

1. Все запросы в Bitrix24 должны идти через единый axios-клиент: /src/core/httpClient.ts.

2. Клиент должен поддерживать:

retries (3 раза),

логирование ошибок,

единый ErrorWrapper.



3. Все инструменты в src/mcp/tools обязаны:

использовать общий клиент,

возвращать единый формат { ok: boolean, data, error },

валидировать входные параметры,

корректно обрабатывать ошибки Bitrix24 (в т.ч. 401, 403, 429).



4. Запрещено:

прямое использование axios в отдельных файлах,

смешивание типов ошибок,

возврат “сырых” данных Bitrix24 без нормализации.



---

4. Требования к серверу (src/server)

1. Добавить единый middleware ошибок: всегда JSON формата:

{ ok: false, message, code, details }



2. Валидация входящих payload перед отправкой инструментам.



3. Логирование всех запросов MCP + время выполнения.



4. На уровне сервера не должно быть “await без try/catch”.



---

5. Требования к OpenAPI

1. Файл openapi.json должен быть:

валидным,

полностью определённым (без пустых schema: {}),

описывать все поля ответа MCP.



2. Для каждого:

инструмента,

операции,

ошибки
— должны быть прописаны properties.



3. После изменений — запускать автоматическую валидацию.



---

6. Тесты

1. Добавить e2e-тест: сервер → MCP → Bitrix-mock → ответ.

2. Для каждого инструмента:

success-case,

error-case,

empty-case,

timeout-case.



3. Покрытие строк: минимум 80%, логики — 90%.



---

7. Docker / Vercel

1. Dockerfile должен собирать проект без dev-зависимостей.

2. docker-compose должен содержать:

healthcheck,

restart policy: always.



3. Для Vercel:

следить за корректностью vercel.json,

убедиться, что сервер собирается в /dist.



---

8. Работа с .env

1. .env.example должен содержать все обязательные переменные.

2. При запуске dev-сервера проверять отсутствующие переменные и выбрасывать ошибку.



---

9. Автоматизация

1. Создать GitHub Actions:

lint,

test,

build,

openapi-validate,

deploy (если требуется).



2. Каждый PR должен запускать все пайплайны.



---

10. Что должен делать Copilot автоматически

1. Предлагать исправления тестов при любом изменении API.

2. Автоматически приводить код под единый стиль (ESLint + Prettier).

3. Предлагать только устойчивые паттерны:
— контроллер → сервис → клиент → нормализация → ответ.

4. Проверять типизацию TS и не допускать any.

5. Автоматически рефакторить дублирующуюся логику.



---

Если хочешь — могу:

собрать .github/CODEOWNERS,

написать CI-pipeline целиком,

создать PR-шаблон,

сформировать diff-патч, который исправит всё автоматически.
